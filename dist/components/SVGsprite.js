"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.SVGSprite = void 0;
const cc_1 = require("cc");
const SVGAssets_1 = require("./SVGAssets");
const { ccclass, property, executeInEditMode, requireComponent, menu, icon } = cc_1._decorator;
let SVGSprite = class SVGSprite extends cc_1.Component {
    constructor() {
        super(...arguments);
        this._svgContent = "";
        this._svgFile = null;
        this.useTextSVG = false;
        // 文本模式下的SVG代码
        this._svgText = "";
        this.svgWidth = 256;
        this.svgHeight = 256;
        this.sprite = null;
        this._color = "#ffffff";
        this.svgElement = null;
        this.canvas = null;
    }
    // 文件模式下的SVG文件引用
    get svgContent() {
        if (this.useTextSVG) {
            return this._svgText;
        }
        else {
            return this._svgFile ? this._svgFile.svgContent : "";
        }
    }
    // 统一setter，根据模式设置对应属性
    set svgContent(value) {
        if (typeof value === "string") {
            // 字符串输入
            if (this._svgText !== value) {
                this._svgText = value;
                this._svgFile = null; // 清除文件引用
                this.renderSVG();
            }
        }
        else if (value instanceof SVGAssets_1.SVGAsset) {
            // 文件输入
            if (this._svgFile !== value) {
                this._svgFile = value;
                this._svgText = ""; // 清除文本内容
                this.renderSVG();
            }
        }
    }
    get color() {
        return this._color;
    }
    set color(value) {
        if (this._color !== value) {
            this._color = value;
            this.updateSVGColor();
        }
    }
    onLoad() {
        this.sprite = this.getComponent(cc_1.Sprite);
        this.initSVGCanvas();
        this.renderSVG();
    }
    initSVGCanvas() {
        this.canvas = document.createElement("canvas");
        this.canvas.width = this.getComponent(cc_1.UITransform).width;
        this.canvas.height = this.getComponent(cc_1.UITransform).height;
        // 创建SVG元素
        this.svgElement = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        this.svgElement.setAttribute("width", "100%");
        this.svgElement.setAttribute("height", "100%");
        this.svgElement.setAttribute("preserveAspectRatio", "xMidYMid meet");
    }
    async renderSVG() {
        if (!this._svgContent)
            return;
        try {
            // 解析SVG
            const parser = new DOMParser();
            const doc = parser.parseFromString(this._svgContent, "image/svg+xml");
            const svg = doc.documentElement;
            // 清空并添加新内容
            while (this.svgElement.firstChild) {
                this.svgElement.removeChild(this.svgElement.firstChild);
            }
            // 复制所有子元素
            for (const child of Array.from(svg.children)) {
                this.svgElement.appendChild(child.cloneNode(true));
            }
            // 应用颜色
            this.updateSVGColor();
            // 渲染到纹理
            await this.renderToTexture();
        }
        catch (error) {
            console.error("SVG解析失败:", error);
        }
    }
    updateSVGColor() {
        if (!this.svgElement)
            return;
        // 查找所有路径元素并设置颜色
        const paths = this.svgElement.querySelectorAll("path");
        paths.forEach((path) => {
            if (!path.getAttribute("fill") || path.getAttribute("fill") !== "none") {
                path.setAttribute("fill", this._color);
            }
        });
    }
    renderToTexture() {
        return new Promise((resolve) => {
            // 创建图片对象
            const svgString = new XMLSerializer().serializeToString(this.svgElement);
            const blob = new Blob([svgString], { type: "image/svg+xml" });
            const url = URL.createObjectURL(blob);
            const img = new Image();
            img.onload = () => {
                // 绘制到canvas
                const ctx = this.canvas.getContext("2d");
                ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                ctx.drawImage(img, 0, 0, this.canvas.width, this.canvas.height);
                // 创建纹理
                this.createTexture();
                URL.revokeObjectURL(url);
                resolve();
            };
            img.src = url;
        });
    }
    createTexture() {
        const imageAsset = new cc_1.ImageAsset(this.canvas);
        const texture = new cc_1.Texture2D();
        texture.image = imageAsset;
        const spriteFrame = new cc_1.SpriteFrame();
        spriteFrame.texture = texture;
        if (this.sprite) {
            this.sprite.spriteFrame = spriteFrame;
        }
    }
    // 动态更新SVG属性
    setSVGAttribute(pathId, attribute, value) {
        const element = this.svgElement.querySelector(`#${pathId}`);
        if (element) {
            element.setAttribute(attribute, value);
            this.renderToTexture();
        }
    }
    /**
     * 手动刷新SVG内容
     */
    refresh() {
        this.renderSVG();
    }
    /**
     * 获取当前模式描述
     */
    get modeDescription() {
        return this.useTextSVG
            ? `文本模式: ${this._svgText.length} 字符`
            : `文件模式: ${this._svgFile ? this._svgFile.name : "无文件"}`;
    }
    onDestroy() {
        if (this.svgElement) {
            this.svgElement.remove();
        }
    }
};
exports.SVGSprite = SVGSprite;
__decorate([
    property
], SVGSprite.prototype, "_svgContent", void 0);
__decorate([
    property({
        displayName: "使用文本输入",
        tooltip: "勾选后直接粘贴SVG代码，取消则选择svg文件",
    })
], SVGSprite.prototype, "useTextSVG", void 0);
__decorate([
    property({
        multiline: true,
        displayName: "SVG代码",
        tooltip: "直接粘贴SVG代码",
        visible: function () {
            return this.useTextSVG;
        },
    })
], SVGSprite.prototype, "_svgText", void 0);
__decorate([
    property({
        type: SVGAssets_1.SVGAsset,
        displayName: "SVG文件",
        tooltip: "选择一个svg文件",
        visible: function () {
            return !this.useTextSVG;
        },
    })
    // 统一的getter，根据模式返回对应内容
], SVGSprite.prototype, "svgContent", null);
__decorate([
    property({
        tooltip: "SVG渲染宽度",
    })
], SVGSprite.prototype, "svgWidth", void 0);
__decorate([
    property({
        tooltip: "SVG渲染高度",
    })
], SVGSprite.prototype, "svgHeight", void 0);
__decorate([
    property
], SVGSprite.prototype, "sprite", void 0);
__decorate([
    property
], SVGSprite.prototype, "_color", void 0);
__decorate([
    property({
        displayName: "颜色覆盖",
    })
], SVGSprite.prototype, "color", null);
exports.SVGSprite = SVGSprite = __decorate([
    ccclass("SVGSprite"),
    icon("../../Inkpen.png"),
    menu("2D/SVGSprite"),
    executeInEditMode,
    requireComponent(cc_1.Sprite)
], SVGSprite);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU1ZHc3ByaXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc291cmNlL2NvbXBvbmVudHMvU1ZHc3ByaXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBLDJCQUE4RztBQUM5RywyQ0FBdUM7QUFDdkMsTUFBTSxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsaUJBQWlCLEVBQUUsZ0JBQWdCLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxHQUFHLGVBQVUsQ0FBQztBQU9uRixJQUFNLFNBQVMsR0FBZixNQUFNLFNBQVUsU0FBUSxjQUFTO0lBQWpDOztRQUVLLGdCQUFXLEdBQVcsRUFBRSxDQUFDO1FBQ3pCLGFBQVEsR0FBb0IsSUFBSSxDQUFDO1FBTXpDLGVBQVUsR0FBWSxLQUFLLENBQUM7UUFFNUIsY0FBYztRQVNOLGFBQVEsR0FBVyxFQUFFLENBQUM7UUEyQ3ZCLGFBQVEsR0FBVyxHQUFHLENBQUM7UUFLdkIsY0FBUyxHQUFXLEdBQUcsQ0FBQztRQUd2QixXQUFNLEdBQVcsSUFBSyxDQUFDO1FBR3ZCLFdBQU0sR0FBVyxTQUFTLENBQUM7UUFnQjNCLGVBQVUsR0FBa0IsSUFBSyxDQUFDO1FBQ2xDLFdBQU0sR0FBc0IsSUFBSyxDQUFDO0lBK0g5QyxDQUFDO0lBcE1HLGdCQUFnQjtJQVdoQixJQUFJLFVBQVU7UUFDVixJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUNsQixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7UUFDekIsQ0FBQzthQUFNLENBQUM7WUFDSixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDekQsQ0FBQztJQUNMLENBQUM7SUFFRCxzQkFBc0I7SUFDdEIsSUFBSSxVQUFVLENBQUMsS0FBd0I7UUFDbkMsSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLEVBQUUsQ0FBQztZQUM1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T0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDO1FBQzNCLENBQUM7S0FDSixDQUFDOzJDQUM0QjtBQWE5QjtJQVZDLFFBQVEsQ0FBQztRQUNOLElBQUksRUFBRSxvQkFBUTtRQUNkLFdBQVcsRUFBRSxPQUFPO1FBQ3BCLE9BQU8sRUFBRSxXQUFXO1FBQ3BCLE9BQU8sRUFBRTtZQUNMLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO1FBQzVCLENBQUM7S0FDSixDQUFDO0lBRUYsdUJBQXVCOzJDQU90QjtBQXdCTTtJQUhOLFFBQVEsQ0FBQztRQUNOLE9BQU8sRUFBRSxTQUFTO0tBQ3JCLENBQUM7MkNBQzRCO0FBS3ZCO0lBSE4sUUFBUSxDQUFDO1FBQ04sT0FBTyxFQUFFLFNBQVM7S0FDckIsQ0FBQzs0Q0FDNkI7QUFHdkI7SUFEUCxRQUFRO3lDQUNzQjtBQUd2QjtJQURQLFFBQVE7eUNBQzBCO0FBS25DO0lBSEMsUUFBUSxDQUFDO1FBQ04sV0FBVyxFQUFFLE1BQU07S0FDdEIsQ0FBQztzQ0FHRDtvQkFqRlEsU0FBUztJQUxyQixPQUFPLENBQUMsV0FBVyxDQUFDO0lBQ3BCLElBQUksQ0FBQyxrQkFBa0IsQ0FBQztJQUN4QixJQUFJLENBQUMsY0FBYyxDQUFDO0lBQ3BCLGlCQUFpQjtJQUNqQixnQkFBZ0IsQ0FBQyxXQUFNLENBQUM7R0FDWixTQUFTLENBME5yQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IF9kZWNvcmF0b3IsIENvbXBvbmVudCwgU3ByaXRlLCBTcHJpdGVGcmFtZSwgVGV4dHVyZTJELCBVSVRyYW5zZm9ybSwgSW1hZ2VBc3NldCwgQ0NTdHJpbmcgfSBmcm9tIFwiY2NcIjtcbmltcG9ydCB7IFNWR0Fzc2V0IH0gZnJvbSBcIi4vU1ZHQXNzZXRzXCI7XG5jb25zdCB7IGNjY2xhc3MsIHByb3BlcnR5LCBleGVjdXRlSW5FZGl0TW9kZSwgcmVxdWlyZUNvbXBvbmVudCwgbWVudSwgaWNvbiB9ID0gX2RlY29yYXRvcjtcblxuQGNjY2xhc3MoXCJTVkdTcHJpdGVcIilcbkBpY29uKFwiLi4vLi4vSW5rcGVuLnBuZ1wiKVxuQG1lbnUoXCIyRC9TVkdTcHJpdGVcIilcbkBleGVjdXRlSW5FZGl0TW9kZVxuQHJlcXVpcmVDb21wb25lbnQoU3ByaXRlKVxuZXhwb3J0IGNsYXNzIFNWR1Nwcml0ZSBleHRlbmRzIENvbXBvbmVudCB7XG4gICAgQHByb3BlcnR5XG4gICAgcHJpdmF0ZSBfc3ZnQ29udGVudDogc3RyaW5nID0gXCJcIjtcbiAgICBwcml2YXRlIF9zdmdGaWxlOiBTVkdBc3NldCB8IG51bGwgPSBudWxsO1xuXG4gICAgQHByb3BlcnR5KHtcbiAgICAgICAgZGlzcGxheU5hbWU6IFwi5L2/55So5paH5pys6L6T5YWlXCIsXG4gICAgICAgIHRvb2x0aXA6IFwi5Yu+6YCJ5ZCO55u05o6l57KY6LS0U1ZH5Luj56CB77yM5Y+W5raI5YiZ6YCJ5oupc3Zn5paH5Lu2XCIsXG4gICAgfSlcbiAgICB1c2VUZXh0U1ZHOiBib29sZWFuID0gZmFsc2U7XG5cbiAgICAvLyDmlofmnKzmqKHlvI/kuIvnmoRTVkfku6PnoIFcbiAgICBAcHJvcGVydHkoe1xuICAgICAgICBtdWx0aWxpbmU6IHRydWUsXG4gICAgICAgIGRpc3BsYXlOYW1lOiBcIlNWR+S7o+eggVwiLFxuICAgICAgICB0b29sdGlwOiBcIuebtOaOpeeymOi0tFNWR+S7o+eggVwiLFxuICAgICAgICB2aXNpYmxlOiBmdW5jdGlvbiAodGhpczogU1ZHU3ByaXRlKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy51c2VUZXh0U1ZHO1xuICAgICAgICB9LFxuICAgIH0pXG4gICAgcHJpdmF0ZSBfc3ZnVGV4dDogc3RyaW5nID0gXCJcIjtcblxuICAgIC8vIOaWh+S7tuaooeW8j+S4i+eahFNWR+aWh+S7tuW8leeUqFxuICAgIEBwcm9wZXJ0eSh7XG4gICAgICAgIHR5cGU6IFNWR0Fzc2V0LFxuICAgICAgICBkaXNwbGF5TmFtZTogXCJTVkfmlofku7ZcIixcbiAgICAgICAgdG9vbHRpcDogXCLpgInmi6nkuIDkuKpzdmfmlofku7ZcIixcbiAgICAgICAgdmlzaWJsZTogZnVuY3Rpb24gKHRoaXM6IFNWR1Nwcml0ZSkge1xuICAgICAgICAgICAgcmV0dXJuICF0aGlzLnVzZVRleHRTVkc7XG4gICAgICAgIH0sXG4gICAgfSlcblxuICAgIC8vIOe7n+S4gOeahGdldHRlcu+8jOagueaNruaooeW8j+i/lOWbnuWvueW6lOWGheWuuVxuICAgIGdldCBzdmdDb250ZW50KCk6IHN0cmluZyB7XG4gICAgICAgIGlmICh0aGlzLnVzZVRleHRTVkcpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9zdmdUZXh0O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3N2Z0ZpbGUgPyB0aGlzLl9zdmdGaWxlLnN2Z0NvbnRlbnQgOiBcIlwiO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8g57uf5LiAc2V0dGVy77yM5qC55o2u5qih5byP6K6+572u5a+55bqU5bGe5oCnXG4gICAgc2V0IHN2Z0NvbnRlbnQodmFsdWU6IHN0cmluZyB8IFNWR0Fzc2V0KSB7XG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgIC8vIOWtl+espuS4sui+k+WFpVxuICAgICAgICAgICAgaWYgKHRoaXMuX3N2Z1RleHQgIT09IHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fc3ZnVGV4dCA9IHZhbHVlO1xuICAgICAgICAgICAgICAgIHRoaXMuX3N2Z0ZpbGUgPSBudWxsOyAvLyDmuIXpmaTmlofku7blvJXnlKhcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclNWRygpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHZhbHVlIGluc3RhbmNlb2YgU1ZHQXNzZXQpIHtcbiAgICAgICAgICAgIC8vIOaWh+S7tui+k+WFpVxuICAgICAgICAgICAgaWYgKHRoaXMuX3N2Z0ZpbGUgIT09IHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fc3ZnRmlsZSA9IHZhbHVlO1xuICAgICAgICAgICAgICAgIHRoaXMuX3N2Z1RleHQgPSBcIlwiOyAvLyDmuIXpmaTmlofmnKzlhoXlrrlcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclNWRygpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgQHByb3BlcnR5KHtcbiAgICAgICAgdG9vbHRpcDogXCJTVkfmuLLmn5Plrr3luqZcIixcbiAgICB9KVxuICAgIHB1YmxpYyBzdmdXaWR0aDogbnVtYmVyID0gMjU2O1xuXG4gICAgQHByb3BlcnR5KHtcbiAgICAgICAgdG9vbHRpcDogXCJTVkfmuLLmn5Ppq5jluqZcIixcbiAgICB9KVxuICAgIHB1YmxpYyBzdmdIZWlnaHQ6IG51bWJlciA9IDI1NjtcblxuICAgIEBwcm9wZXJ0eVxuICAgIHByaXZhdGUgc3ByaXRlOiBTcHJpdGUgPSBudWxsITtcblxuICAgIEBwcm9wZXJ0eVxuICAgIHByaXZhdGUgX2NvbG9yOiBzdHJpbmcgPSBcIiNmZmZmZmZcIjtcblxuICAgIEBwcm9wZXJ0eSh7XG4gICAgICAgIGRpc3BsYXlOYW1lOiBcIuminOiJsuimhuebllwiLFxuICAgIH0pXG4gICAgZ2V0IGNvbG9yKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl9jb2xvcjtcbiAgICB9XG5cbiAgICBzZXQgY29sb3IodmFsdWU6IHN0cmluZykge1xuICAgICAgICBpZiAodGhpcy5fY29sb3IgIT09IHZhbHVlKSB7XG4gICAgICAgICAgICB0aGlzLl9jb2xvciA9IHZhbHVlO1xuICAgICAgICAgICAgdGhpcy51cGRhdGVTVkdDb2xvcigpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdmdFbGVtZW50OiBTVkdTVkdFbGVtZW50ID0gbnVsbCE7XG4gICAgcHJpdmF0ZSBjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50ID0gbnVsbCE7XG5cbiAgICBvbkxvYWQoKSB7XG4gICAgICAgIHRoaXMuc3ByaXRlID0gdGhpcy5nZXRDb21wb25lbnQoU3ByaXRlKSE7XG4gICAgICAgIHRoaXMuaW5pdFNWR0NhbnZhcygpO1xuICAgICAgICB0aGlzLnJlbmRlclNWRygpO1xuICAgIH1cblxuICAgIHByaXZhdGUgaW5pdFNWR0NhbnZhcygpIHtcbiAgICAgICAgdGhpcy5jYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiY2FudmFzXCIpO1xuICAgICAgICB0aGlzLmNhbnZhcy53aWR0aCA9IHRoaXMuZ2V0Q29tcG9uZW50KFVJVHJhbnNmb3JtKSEud2lkdGg7XG4gICAgICAgIHRoaXMuY2FudmFzLmhlaWdodCA9IHRoaXMuZ2V0Q29tcG9uZW50KFVJVHJhbnNmb3JtKSEuaGVpZ2h0O1xuXG4gICAgICAgIC8vIOWIm+W7ulNWR+WFg+e0oFxuICAgICAgICB0aGlzLnN2Z0VsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoXCJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Z1wiLCBcInN2Z1wiKTtcbiAgICAgICAgdGhpcy5zdmdFbGVtZW50LnNldEF0dHJpYnV0ZShcIndpZHRoXCIsIFwiMTAwJVwiKTtcbiAgICAgICAgdGhpcy5zdmdFbGVtZW50LnNldEF0dHJpYnV0ZShcImhlaWdodFwiLCBcIjEwMCVcIik7XG4gICAgICAgIHRoaXMuc3ZnRWxlbWVudC5zZXRBdHRyaWJ1dGUoXCJwcmVzZXJ2ZUFzcGVjdFJhdGlvXCIsIFwieE1pZFlNaWQgbWVldFwiKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIHJlbmRlclNWRygpIHtcbiAgICAgICAgaWYgKCF0aGlzLl9zdmdDb250ZW50KSByZXR1cm47XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIC8vIOino+aekFNWR1xuICAgICAgICAgICAgY29uc3QgcGFyc2VyID0gbmV3IERPTVBhcnNlcigpO1xuICAgICAgICAgICAgY29uc3QgZG9jID0gcGFyc2VyLnBhcnNlRnJvbVN0cmluZyh0aGlzLl9zdmdDb250ZW50LCBcImltYWdlL3N2Zyt4bWxcIik7XG4gICAgICAgICAgICBjb25zdCBzdmcgPSBkb2MuZG9jdW1lbnRFbGVtZW50O1xuXG4gICAgICAgICAgICAvLyDmuIXnqbrlubbmt7vliqDmlrDlhoXlrrlcbiAgICAgICAgICAgIHdoaWxlICh0aGlzLnN2Z0VsZW1lbnQuZmlyc3RDaGlsZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc3ZnRWxlbWVudC5yZW1vdmVDaGlsZCh0aGlzLnN2Z0VsZW1lbnQuZmlyc3RDaGlsZCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIOWkjeWItuaJgOacieWtkOWFg+e0oFxuICAgICAgICAgICAgZm9yIChjb25zdCBjaGlsZCBvZiBBcnJheS5mcm9tKHN2Zy5jaGlsZHJlbikpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnN2Z0VsZW1lbnQuYXBwZW5kQ2hpbGQoY2hpbGQuY2xvbmVOb2RlKHRydWUpKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8g5bqU55So6aKc6ImyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVNWR0NvbG9yKCk7XG5cbiAgICAgICAgICAgIC8vIOa4suafk+WIsOe6ueeQhlxuICAgICAgICAgICAgYXdhaXQgdGhpcy5yZW5kZXJUb1RleHR1cmUoKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJTVkfop6PmnpDlpLHotKU6XCIsIGVycm9yKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgdXBkYXRlU1ZHQ29sb3IoKSB7XG4gICAgICAgIGlmICghdGhpcy5zdmdFbGVtZW50KSByZXR1cm47XG5cbiAgICAgICAgLy8g5p+l5om+5omA5pyJ6Lev5b6E5YWD57Sg5bm26K6+572u6aKc6ImyXG4gICAgICAgIGNvbnN0IHBhdGhzID0gdGhpcy5zdmdFbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCJwYXRoXCIpO1xuICAgICAgICBwYXRocy5mb3JFYWNoKChwYXRoKSA9PiB7XG4gICAgICAgICAgICBpZiAoIXBhdGguZ2V0QXR0cmlidXRlKFwiZmlsbFwiKSB8fCBwYXRoLmdldEF0dHJpYnV0ZShcImZpbGxcIikgIT09IFwibm9uZVwiKSB7XG4gICAgICAgICAgICAgICAgcGF0aC5zZXRBdHRyaWJ1dGUoXCJmaWxsXCIsIHRoaXMuX2NvbG9yKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZW5kZXJUb1RleHR1cmUoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgICAgLy8g5Yib5bu65Zu+54mH5a+56LGhXG4gICAgICAgICAgICBjb25zdCBzdmdTdHJpbmcgPSBuZXcgWE1MU2VyaWFsaXplcigpLnNlcmlhbGl6ZVRvU3RyaW5nKHRoaXMuc3ZnRWxlbWVudCk7XG4gICAgICAgICAgICBjb25zdCBibG9iID0gbmV3IEJsb2IoW3N2Z1N0cmluZ10sIHsgdHlwZTogXCJpbWFnZS9zdmcreG1sXCIgfSk7XG4gICAgICAgICAgICBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpO1xuXG4gICAgICAgICAgICBjb25zdCBpbWcgPSBuZXcgSW1hZ2UoKTtcbiAgICAgICAgICAgIGltZy5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgLy8g57uY5Yi25YiwY2FudmFzXG4gICAgICAgICAgICAgICAgY29uc3QgY3R4ID0gdGhpcy5jYW52YXMuZ2V0Q29udGV4dChcIjJkXCIpITtcbiAgICAgICAgICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIHRoaXMuY2FudmFzLndpZHRoLCB0aGlzLmNhbnZhcy5oZWlnaHQpO1xuICAgICAgICAgICAgICAgIGN0eC5kcmF3SW1hZ2UoaW1nLCAwLCAwLCB0aGlzLmNhbnZhcy53aWR0aCwgdGhpcy5jYW52YXMuaGVpZ2h0KTtcblxuICAgICAgICAgICAgICAgIC8vIOWIm+W7uue6ueeQhlxuICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlVGV4dHVyZSgpO1xuICAgICAgICAgICAgICAgIFVSTC5yZXZva2VPYmplY3RVUkwodXJsKTtcbiAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBpbWcuc3JjID0gdXJsO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNyZWF0ZVRleHR1cmUoKSB7XG4gICAgICAgIGNvbnN0IGltYWdlQXNzZXQgPSBuZXcgSW1hZ2VBc3NldCh0aGlzLmNhbnZhcyk7XG4gICAgICAgIGNvbnN0IHRleHR1cmUgPSBuZXcgVGV4dHVyZTJEKCk7XG4gICAgICAgIHRleHR1cmUuaW1hZ2UgPSBpbWFnZUFzc2V0O1xuXG4gICAgICAgIGNvbnN0IHNwcml0ZUZyYW1lID0gbmV3IFNwcml0ZUZyYW1lKCk7XG4gICAgICAgIHNwcml0ZUZyYW1lLnRleHR1cmUgPSB0ZXh0dXJlO1xuXG4gICAgICAgIGlmICh0aGlzLnNwcml0ZSkge1xuICAgICAgICAgICAgdGhpcy5zcHJpdGUuc3ByaXRlRnJhbWUgPSBzcHJpdGVGcmFtZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIOWKqOaAgeabtOaWsFNWR+WxnuaAp1xuICAgIHB1YmxpYyBzZXRTVkdBdHRyaWJ1dGUocGF0aElkOiBzdHJpbmcsIGF0dHJpYnV0ZTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IGVsZW1lbnQgPSB0aGlzLnN2Z0VsZW1lbnQucXVlcnlTZWxlY3RvcihgIyR7cGF0aElkfWApO1xuICAgICAgICBpZiAoZWxlbWVudCkge1xuICAgICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoYXR0cmlidXRlLCB2YWx1ZSk7XG4gICAgICAgICAgICB0aGlzLnJlbmRlclRvVGV4dHVyZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5omL5Yqo5Yi35pawU1ZH5YaF5a65XG4gICAgICovXG4gICAgcHVibGljIHJlZnJlc2goKTogdm9pZCB7XG4gICAgICAgIHRoaXMucmVuZGVyU1ZHKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog6I635Y+W5b2T5YmN5qih5byP5o+P6L+wXG4gICAgICovXG4gICAgcHVibGljIGdldCBtb2RlRGVzY3JpcHRpb24oKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudXNlVGV4dFNWR1xuICAgICAgICAgICAgPyBg5paH5pys5qih5byPOiAke3RoaXMuX3N2Z1RleHQubGVuZ3RofSDlrZfnrKZgXG4gICAgICAgICAgICA6IGDmlofku7bmqKHlvI86ICR7dGhpcy5fc3ZnRmlsZSA/IHRoaXMuX3N2Z0ZpbGUubmFtZSA6IFwi5peg5paH5Lu2XCJ9YDtcbiAgICB9XG4gICAgb25EZXN0cm95KCkge1xuICAgICAgICBpZiAodGhpcy5zdmdFbGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLnN2Z0VsZW1lbnQucmVtb3ZlKCk7XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=