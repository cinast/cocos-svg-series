"use strict";
// === 修正后的 SVGImporter.ts ===
Object.defineProperty(exports, "__esModule", { value: true });
exports.SVGAssetProcessor = exports.SVGImporter = void 0;
// 移除cc导入，使用Editor API
/// <reference types="@cocos/creator-types/editor" />
/**
 * SVG资源导入器（主进程版本）
 * 使用Editor API与资源数据库交互
 */
class SVGImporter {
    /**
     * 导入SVG文件
     */
    static async import(filePath) {
        try {
            // 1. 读取文件内容（使用Node.js的fs模块）
            const content = await SVGImporter.readFileViaEditor(filePath); // ✅ 正确调用静态方法
            if (!content) {
                console.error(`无法读取SVG文件: ${filePath}`);
                return false;
            }
            // 2. 解析SVG信息（纯文本解析，不使用DOM API）
            const svgInfo = SVGImporter.parseSVGInfoText(content); // ✅ 正确调用静态方法
            // 3. 创建资源的meta文件
            const uuid = await Editor.Message.request("asset-db", "query-uuid", filePath);
            if (!uuid) {
                console.error(`无法获取文件的UUID: ${filePath}`);
                return false;
            }
            // 4. 构建meta数据
            const meta = {
                uuid: uuid,
                imported: true,
                importer: "svg-asset",
                type: "cc.SVGAsset", // 自定义类型
                files: [filePath],
                subMetas: {},
                userData: Object.assign(Object.assign({ type: "svg-asset", svgContent: content }, svgInfo), { sourceFile: filePath, lastModified: Date.now() }),
                ver: "1.0.0",
            };
            // 5. 保存meta文件
            await Editor.Message.request("asset-db", "save-asset-meta", uuid, JSON.stringify(meta, null, 2));
            console.log(`SVG文件导入完成: ${filePath}`);
            return true;
        }
        catch (error) {
            console.error(`SVG导入过程中发生错误:`, error);
            return false;
        }
    }
    /**
     * 通过Node.js fs模块读取文件（主进程可用）
     */
    static async readFileViaEditor(filePath) {
        try {
            // 使用Node.js的fs模块在主进程读取文件
            const fs = require("fs"); // ✅ Node.js的fs模块在主进程可用
            return new Promise((resolve, reject) => {
                fs.readFile(filePath, "utf-8", (err, data) => {
                    if (err) {
                        console.error(`读取文件失败: ${filePath}`, err);
                        resolve(null);
                    }
                    else {
                        resolve(data);
                    }
                });
            });
        }
        catch (error) {
            console.error(`读取文件失败: ${filePath}`, error);
            return null;
        }
    }
    /**
     * 纯文本解析SVG信息（不使用DOM API）
     */
    static parseSVGInfoText(svgContent) {
        // 使用正则表达式从文本中提取信息
        const widthMatch = svgContent.match(/width="([^"]+)"/);
        const heightMatch = svgContent.match(/height="([^"]+)"/);
        const viewBoxMatch = svgContent.match(/viewBox="([^"]+)"/);
        const titleMatch = svgContent.match(/<title>([^<]+)<\/title>/);
        const descMatch = svgContent.match(/<desc>([^<]+)<\/desc>/);
        let width = 100, height = 100;
        if (widthMatch)
            width = SVGImporter.parseDimension(widthMatch[1]); // ✅ 正确调用静态方法
        if (heightMatch)
            height = SVGImporter.parseDimension(heightMatch[1]); // ✅ 正确调用静态方法
        // 从viewBox解析尺寸（如果存在）
        if (viewBoxMatch && viewBoxMatch[1]) {
            const parts = viewBoxMatch[1].split(" ").map(Number);
            if (parts.length >= 4 && parts[2] > 0 && parts[3] > 0) {
                width = parts[2];
                height = parts[3];
            }
        }
        return {
            width,
            height,
            aspectRatio: height > 0 ? width / height : 1,
            viewBox: viewBoxMatch ? viewBoxMatch[1] : "",
            defaultColor: "#ffffff",
            title: titleMatch ? titleMatch[1] : "",
            description: descMatch ? descMatch[1] : "",
        };
    }
    static parseDimension(dim) {
        const num = parseFloat(dim);
        return isNaN(num) ? 0 : num;
    }
}
exports.SVGImporter = SVGImporter;
/**
 * SVG资源处理器
 */
class SVGAssetProcessor {
    static async process(filePath) {
        return await SVGImporter.import(filePath);
    }
    /**
     * 获取SVG预览 - 此方法需要在面板（渲染进程）中实现
     */
    static async getPreview(filePath) {
        // 这里不直接渲染，而是返回文件信息
        // 实际渲染应该在面板中进行
        const content = await SVGImporter.readFileViaEditor(filePath); // ✅ 直接调用静态方法
        if (!content)
            return null;
        const info = SVGImporter.parseSVGInfoText(content); // ✅ 直接调用静态方法
        return Object.assign(Object.assign({ filePath }, info), { hasContent: !!content });
    }
}
exports.SVGAssetProcessor = SVGAssetProcessor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU1ZHSW1wb3J0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zb3VyY2UvU1ZHSW1wb3J0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLDhCQUE4Qjs7O0FBRTlCLHNCQUFzQjtBQUN0QixxREFBcUQ7QUFFckQ7OztHQUdHO0FBQ0gsTUFBYSxXQUFXO0lBQ3BCOztPQUVHO0lBQ0gsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsUUFBZ0I7UUFDaEMsSUFBSSxDQUFDO1lBQ0QsNEJBQTRCO1lBQzVCLE1BQU0sT0FBTyxHQUFHLE1BQU0sV0FBVyxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsYUFBYTtZQUM1RSxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQ1gsT0FBTyxDQUFDLEtBQUssQ0FBQyxjQUFjLFFBQVEsRUFBRSxDQUFDLENBQUM7Z0JBQ3hDLE9BQU8sS0FBSyxDQUFDO1lBQ2pCLENBQUM7WUFFRCwrQkFBK0I7WUFDL0IsTUFBTSxPQUFPLEdBQUcsV0FBVyxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsYUFBYTtZQUVwRSxpQkFBaUI7WUFDakIsTUFBTSxJQUFJLEdBQUcsTUFBTSxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsWUFBWSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQzlFLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDUixPQUFPLENBQUMsS0FBSyxDQUFDLGdCQUFnQixRQUFRLEVBQUUsQ0FBQyxDQUFDO2dCQUMxQyxPQUFPLEtBQUssQ0FBQztZQUNqQixDQUFDO1lBRUQsY0FBYztZQUNkLE1BQU0sSUFBSSxHQUFHO2dCQUNULElBQUksRUFBRSxJQUFJO2dCQUNWLFFBQVEsRUFBRSxJQUFJO2dCQUNkLFFBQVEsRUFBRSxXQUFXO2dCQUNyQixJQUFJLEVBQUUsYUFBYSxFQUFFLFFBQVE7Z0JBQzdCLEtBQUssRUFBRSxDQUFD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RztBQUNILE1BQWEsaUJBQWlCO0lBQzFCLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQWdCO1FBQ2pDLE9BQU8sTUFBTSxXQUFXLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQzlDLENBQUM7SUFFRDs7T0FFRztJQUNILE1BQU0sQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLFFBQWdCO1FBQ3BDLG1CQUFtQjtRQUNuQixlQUFlO1FBQ2YsTUFBTSxPQUFPLEdBQUcsTUFBTSxXQUFXLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxhQUFhO1FBQzVFLElBQUksQ0FBQyxPQUFPO1lBQUUsT0FBTyxJQUFJLENBQUM7UUFFMUIsTUFBTSxJQUFJLEdBQUcsV0FBVyxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsYUFBYTtRQUNqRSxxQ0FDSSxRQUFRLElBQ0wsSUFBSSxLQUNQLFVBQVUsRUFBRSxDQUFDLENBQUMsT0FBTyxJQUN2QjtJQUNOLENBQUM7Q0FDSjtBQXJCRCw4Q0FxQkMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyA9PT0g5L+u5q2j5ZCO55qEIFNWR0ltcG9ydGVyLnRzID09PVxyXG5cclxuLy8g56e76ZmkY2Plr7zlhaXvvIzkvb/nlKhFZGl0b3IgQVBJXHJcbi8vLyA8cmVmZXJlbmNlIHR5cGVzPVwiQGNvY29zL2NyZWF0b3ItdHlwZXMvZWRpdG9yXCIgLz5cclxuXHJcbi8qKlxyXG4gKiBTVkfotYTmupDlr7zlhaXlmajvvIjkuLvov5vnqIvniYjmnKzvvIlcclxuICog5L2/55SoRWRpdG9yIEFQSeS4jui1hOa6kOaVsOaNruW6k+S6pOS6klxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIFNWR0ltcG9ydGVyIHtcclxuICAgIC8qKlxyXG4gICAgICog5a+85YWlU1ZH5paH5Lu2XHJcbiAgICAgKi9cclxuICAgIHN0YXRpYyBhc3luYyBpbXBvcnQoZmlsZVBhdGg6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIC8vIDEuIOivu+WPluaWh+S7tuWGheWuue+8iOS9v+eUqE5vZGUuanPnmoRmc+aooeWdl++8iVxyXG4gICAgICAgICAgICBjb25zdCBjb250ZW50ID0gYXdhaXQgU1ZHSW1wb3J0ZXIucmVhZEZpbGVWaWFFZGl0b3IoZmlsZVBhdGgpOyAvLyDinIUg5q2j56Gu6LCD55So6Z2Z5oCB5pa55rOVXHJcbiAgICAgICAgICAgIGlmICghY29udGVudCkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihg5peg5rOV6K+75Y+WU1ZH5paH5Lu2OiAke2ZpbGVQYXRofWApO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyAyLiDop6PmnpBTVkfkv6Hmga/vvIjnuq/mlofmnKzop6PmnpDvvIzkuI3kvb/nlKhET00gQVBJ77yJXHJcbiAgICAgICAgICAgIGNvbnN0IHN2Z0luZm8gPSBTVkdJbXBvcnRlci5wYXJzZVNWR0luZm9UZXh0KGNvbnRlbnQpOyAvLyDinIUg5q2j56Gu6LCD55So6Z2Z5oCB5pa55rOVXHJcblxyXG4gICAgICAgICAgICAvLyAzLiDliJvlu7rotYTmupDnmoRtZXRh5paH5Lu2XHJcbiAgICAgICAgICAgIGNvbnN0IHV1aWQgPSBhd2FpdCBFZGl0b3IuTWVzc2FnZS5yZXF1ZXN0KFwiYXNzZXQtZGJcIiwgXCJxdWVyeS11dWlkXCIsIGZpbGVQYXRoKTtcclxuICAgICAgICAgICAgaWYgKCF1dWlkKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGDml6Dms5Xojrflj5bmlofku7bnmoRVVUlEOiAke2ZpbGVQYXRofWApO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyA0LiDmnoTlu7ptZXRh5pWw5o2uXHJcbiAgICAgICAgICAgIGNvbnN0IG1ldGEgPSB7XHJcbiAgICAgICAgICAgICAgICB1dWlkOiB1dWlkLFxyXG4gICAgICAgICAgICAgICAgaW1wb3J0ZWQ6IHRydWUsXHJcbiAgICAgICAgICAgICAgICBpbXBvcnRlcjogXCJzdmctYXNzZXRcIixcclxuICAgICAgICAgICAgICAgIHR5cGU6IFwiY2MuU1ZHQXNzZXRcIiwgLy8g6Ieq5a6a5LmJ57G75Z6LXHJcbiAgICAgICAgICAgICAgICBmaWxlczogW2ZpbGVQYXRoXSxcclxuICAgICAgICAgICAgICAgIHN1Yk1ldGFzOiB7fSxcclxuICAgICAgICAgICAgICAgIHVzZXJEYXRhOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogXCJzdmctYXNzZXRcIixcclxuICAgICAgICAgICAgICAgICAgICBzdmdDb250ZW50OiBjb250ZW50LFxyXG4gICAgICAgICAgICAgICAgICAgIC4uLnN2Z0luZm8sXHJcbiAgICAgICAgICAgICAgICAgICAgc291cmNlRmlsZTogZmlsZVBhdGgsXHJcbiAgICAgICAgICAgICAgICAgICAgbGFzdE1vZGlmaWVkOiBEYXRlLm5vdygpLFxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIHZlcjogXCIxLjAuMFwiLFxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgLy8gNS4g5L+d5a2YbWV0YeaWh+S7tlxyXG4gICAgICAgICAgICBhd2FpdCBFZGl0b3IuTWVzc2FnZS5yZXF1ZXN0KFwiYXNzZXQtZGJcIiwgXCJzYXZlLWFzc2V0LW1ldGFcIiwgdXVpZCwgSlNPTi5zdHJpbmdpZnkobWV0YSwgbnVsbCwgMikpO1xyXG5cclxuICAgICAgICAgICAgY29uc29sZS5sb2coYFNWR+aWh+S7tuWvvOWFpeWujOaIkDogJHtmaWxlUGF0aH1gKTtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihgU1ZH5a+85YWl6L+H56iL5Lit5Y+R55Sf6ZSZ6K+vOmAsIGVycm9yKTtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOmAmui/h05vZGUuanMgZnPmqKHlnZfor7vlj5bmlofku7bvvIjkuLvov5vnqIvlj6/nlKjvvIlcclxuICAgICAqL1xyXG4gICAgc3RhdGljIGFzeW5jIHJlYWRGaWxlVmlhRWRpdG9yKGZpbGVQYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZyB8IG51bGw+IHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAvLyDkvb/nlKhOb2RlLmpz55qEZnPmqKHlnZflnKjkuLvov5vnqIvor7vlj5bmlofku7ZcclxuICAgICAgICAgICAgY29uc3QgZnMgPSByZXF1aXJlKFwiZnNcIik7IC8vIOKchSBOb2RlLmpz55qEZnPmqKHlnZflnKjkuLvov5vnqIvlj6/nlKhcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgICAgIGZzLnJlYWRGaWxlKGZpbGVQYXRoLCBcInV0Zi04XCIsIChlcnI6IGFueSwgZGF0YTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGDor7vlj5bmlofku7blpLHotKU6ICR7ZmlsZVBhdGh9YCwgZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShudWxsKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGDor7vlj5bmlofku7blpLHotKU6ICR7ZmlsZVBhdGh9YCwgZXJyb3IpO1xyXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDnuq/mlofmnKzop6PmnpBTVkfkv6Hmga/vvIjkuI3kvb/nlKhET00gQVBJ77yJXHJcbiAgICAgKi9cclxuICAgIHN0YXRpYyBwYXJzZVNWR0luZm9UZXh0KHN2Z0NvbnRlbnQ6IHN0cmluZyk6IGFueSB7XHJcbiAgICAgICAgLy8g5L2/55So5q2j5YiZ6KGo6L6+5byP5LuO5paH5pys5Lit5o+Q5Y+W5L+h5oGvXHJcbiAgICAgICAgY29uc3Qgd2lkdGhNYXRjaCA9IHN2Z0NvbnRlbnQubWF0Y2goL3dpZHRoPVwiKFteXCJdKylcIi8pO1xyXG4gICAgICAgIGNvbnN0IGhlaWdodE1hdGNoID0gc3ZnQ29udGVudC5tYXRjaCgvaGVpZ2h0PVwiKFteXCJdKylcIi8pO1xyXG4gICAgICAgIGNvbnN0IHZpZXdCb3hNYXRjaCA9IHN2Z0NvbnRlbnQubWF0Y2goL3ZpZXdCb3g9XCIoW15cIl0rKVwiLyk7XHJcbiAgICAgICAgY29uc3QgdGl0bGVNYXRjaCA9IHN2Z0NvbnRlbnQubWF0Y2goLzx0aXRsZT4oW148XSspPFxcL3RpdGxlPi8pO1xyXG4gICAgICAgIGNvbnN0IGRlc2NNYXRjaCA9IHN2Z0NvbnRlbnQubWF0Y2goLzxkZXNjPihbXjxdKyk8XFwvZGVzYz4vKTtcclxuXHJcbiAgICAgICAgbGV0IHdpZHRoID0gMTAwLFxyXG4gICAgICAgICAgICBoZWlnaHQgPSAxMDA7XHJcblxyXG4gICAgICAgIGlmICh3aWR0aE1hdGNoKSB3aWR0aCA9IFNWR0ltcG9ydGVyLnBhcnNlRGltZW5zaW9uKHdpZHRoTWF0Y2hbMV0pOyAvLyDinIUg5q2j56Gu6LCD55So6Z2Z5oCB5pa55rOVXHJcbiAgICAgICAgaWYgKGhlaWdodE1hdGNoKSBoZWlnaHQgPSBTVkdJbXBvcnRlci5wYXJzZURpbWVuc2lvbihoZWlnaHRNYXRjaFsxXSk7IC8vIOKchSDmraPnoa7osIPnlKjpnZnmgIHmlrnms5VcclxuXHJcbiAgICAgICAgLy8g5LuOdmlld0JveOino+aekOWwuuWvuO+8iOWmguaenOWtmOWcqO+8iVxyXG4gICAgICAgIGlmICh2aWV3Qm94TWF0Y2ggJiYgdmlld0JveE1hdGNoWzFdKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhcnRzID0gdmlld0JveE1hdGNoWzFdLnNwbGl0KFwiIFwiKS5tYXAoTnVtYmVyKTtcclxuICAgICAgICAgICAgaWYgKHBhcnRzLmxlbmd0aCA+PSA0ICYmIHBhcnRzWzJdID4gMCAmJiBwYXJ0c1szXSA+IDApIHtcclxuICAgICAgICAgICAgICAgIHdpZHRoID0gcGFydHNbMl07XHJcbiAgICAgICAgICAgICAgICBoZWlnaHQgPSBwYXJ0c1szXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgd2lkdGgsXHJcbiAgICAgICAgICAgIGhlaWdodCxcclxuICAgICAgICAgICAgYXNwZWN0UmF0aW86IGhlaWdodCA+IDAgPyB3aWR0aCAvIGhlaWdodCA6IDEsXHJcbiAgICAgICAgICAgIHZpZXdCb3g6IHZpZXdCb3hNYXRjaCA/IHZpZXdCb3hNYXRjaFsxXSA6IFwiXCIsXHJcbiAgICAgICAgICAgIGRlZmF1bHRDb2xvcjogXCIjZmZmZmZmXCIsXHJcbiAgICAgICAgICAgIHRpdGxlOiB0aXRsZU1hdGNoID8gdGl0bGVNYXRjaFsxXSA6IFwiXCIsXHJcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBkZXNjTWF0Y2ggPyBkZXNjTWF0Y2hbMV0gOiBcIlwiLFxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgcGFyc2VEaW1lbnNpb24oZGltOiBzdHJpbmcpOiBudW1iZXIge1xyXG4gICAgICAgIGNvbnN0IG51bSA9IHBhcnNlRmxvYXQoZGltKTtcclxuICAgICAgICByZXR1cm4gaXNOYU4obnVtKSA/IDAgOiBudW07XHJcbiAgICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBTVkfotYTmupDlpITnkIblmahcclxuICovXHJcbmV4cG9ydCBjbGFzcyBTVkdBc3NldFByb2Nlc3NvciB7XHJcbiAgICBzdGF0aWMgYXN5bmMgcHJvY2VzcyhmaWxlUGF0aDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XHJcbiAgICAgICAgcmV0dXJuIGF3YWl0IFNWR0ltcG9ydGVyLmltcG9ydChmaWxlUGF0aCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDojrflj5ZTVkfpooTop4ggLSDmraTmlrnms5XpnIDopoHlnKjpnaLmnb/vvIjmuLLmn5Pov5vnqIvvvInkuK3lrp7njrBcclxuICAgICAqL1xyXG4gICAgc3RhdGljIGFzeW5jIGdldFByZXZpZXcoZmlsZVBhdGg6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XHJcbiAgICAgICAgLy8g6L+Z6YeM5LiN55u05o6l5riy5p+T77yM6ICM5piv6L+U5Zue5paH5Lu25L+h5oGvXHJcbiAgICAgICAgLy8g5a6e6ZmF5riy5p+T5bqU6K+l5Zyo6Z2i5p2/5Lit6L+b6KGMXHJcbiAgICAgICAgY29uc3QgY29udGVudCA9IGF3YWl0IFNWR0ltcG9ydGVyLnJlYWRGaWxlVmlhRWRpdG9yKGZpbGVQYXRoKTsgLy8g4pyFIOebtOaOpeiwg+eUqOmdmeaAgeaWueazlVxyXG4gICAgICAgIGlmICghY29udGVudCkgcmV0dXJuIG51bGw7XHJcblxyXG4gICAgICAgIGNvbnN0IGluZm8gPSBTVkdJbXBvcnRlci5wYXJzZVNWR0luZm9UZXh0KGNvbnRlbnQpOyAvLyDinIUg55u05o6l6LCD55So6Z2Z5oCB5pa55rOVXHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgZmlsZVBhdGgsXHJcbiAgICAgICAgICAgIC4uLmluZm8sXHJcbiAgICAgICAgICAgIGhhc0NvbnRlbnQ6ICEhY29udGVudCxcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG59XHJcbiJdfQ==