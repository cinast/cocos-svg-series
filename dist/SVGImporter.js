"use strict";
/// <reference types="@cocos/creator-types/editor" />
Object.defineProperty(exports, "__esModule", { value: true });
exports.SVGAssetProcessor = exports.SVGImporter = void 0;
/**
 * SVG资源导入器（主进程版本）
 * 使用Editor API与资源数据库交互
 */
class SVGImporter {
    /**
     * 导入SVG文件
     */
    static async import(filePath) {
        try {
            // 1. 读取文件内容（使用Node.js的fs模块）
            const content = await SVGImporter.readFileViaEditor(filePath); // ✅ 正确调用静态方法
            if (!content) {
                console.error(`无法读取SVG文件: ${filePath}`);
                return false;
            }
            // 2. 解析SVG信息（纯文本解析，不使用DOM API）
            const svgInfo = SVGImporter.parseSVGInfoText(content); // ✅ 正确调用静态方法
            // 3. 创建资源的meta文件
            const uuid = await Editor.Message.request("asset-db", "query-uuid", filePath);
            if (!uuid) {
                console.error(`无法获取文件的UUID: ${filePath}`);
                return false;
            }
            // 4. 构建meta数据
            const meta = {
                uuid: uuid,
                imported: true,
                importer: "svg-asset",
                type: "cc.SVGAsset", // 自定义类型
                files: [filePath],
                subMetas: {},
                userData: Object.assign(Object.assign({ type: "svg-asset", svgContent: content }, svgInfo), { sourceFile: filePath, lastModified: Date.now() }),
                ver: "1.0.0",
            };
            // 5. 保存meta文件
            await Editor.Message.request("asset-db", "save-asset-meta", uuid, JSON.stringify(meta, null, 2));
            console.log(`SVG文件导入完成: ${filePath}`);
            return true;
        }
        catch (error) {
            console.error(`SVG导入过程中发生错误:`, error);
            return false;
        }
    }
    /**
     * 通过Node.js fs模块读取文件（主进程可用）
     */
    static async readFileViaEditor(filePath) {
        try {
            // 使用Node.js的fs模块在主进程读取文件
            const fs = require("fs"); // ✅ Node.js的fs模块在主进程可用
            return new Promise((resolve, reject) => {
                fs.readFile(filePath, "utf-8", (err, data) => {
                    if (err) {
                        console.error(`读取文件失败: ${filePath}`, err);
                        resolve(null);
                    }
                    else {
                        resolve(data);
                    }
                });
            });
        }
        catch (error) {
            console.error(`读取文件失败: ${filePath}`, error);
            return null;
        }
    }
    /**
     * 纯文本解析SVG信息（不使用DOM API）
     */
    static parseSVGInfoText(svgContent) {
        // 使用正则表达式从文本中提取信息
        const widthMatch = svgContent.match(/width="([^"]+)"/);
        const heightMatch = svgContent.match(/height="([^"]+)"/);
        const viewBoxMatch = svgContent.match(/viewBox="([^"]+)"/);
        const titleMatch = svgContent.match(/<title>([^<]+)<\/title>/);
        const descMatch = svgContent.match(/<desc>([^<]+)<\/desc>/);
        let width = 100, height = 100;
        if (widthMatch)
            width = SVGImporter.parseDimension(widthMatch[1]); // ✅ 正确调用静态方法
        if (heightMatch)
            height = SVGImporter.parseDimension(heightMatch[1]); // ✅ 正确调用静态方法
        // 从viewBox解析尺寸（如果存在）
        if (viewBoxMatch && viewBoxMatch[1]) {
            const parts = viewBoxMatch[1].split(" ").map(Number);
            if (parts.length >= 4 && parts[2] > 0 && parts[3] > 0) {
                width = parts[2];
                height = parts[3];
            }
        }
        return {
            width,
            height,
            aspectRatio: height > 0 ? width / height : 1,
            viewBox: viewBoxMatch ? viewBoxMatch[1] : "",
            defaultColor: "#ffffff",
            title: titleMatch ? titleMatch[1] : "",
            description: descMatch ? descMatch[1] : "",
        };
    }
    static parseDimension(dim) {
        const num = parseFloat(dim);
        return isNaN(num) ? 0 : num;
    }
}
exports.SVGImporter = SVGImporter;
/**
 * SVG资源处理器
 */
class SVGAssetProcessor {
    static async process(filePath) {
        return await SVGImporter.import(filePath);
    }
    /**
     * 获取SVG预览 - 此方法需要在面板（渲染进程）中实现
     */
    static async getPreview(filePath) {
        // 这里不直接渲染，而是返回文件信息
        // 实际渲染应该在面板中进行
        const content = await SVGImporter.readFileViaEditor(filePath); // ✅ 直接调用静态方法
        if (!content)
            return null;
        const info = SVGImporter.parseSVGInfoText(content); // ✅ 直接调用静态方法
        return Object.assign(Object.assign({ filePath }, info), { hasContent: !!content });
    }
}
exports.SVGAssetProcessor = SVGAssetProcessor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU1ZHSW1wb3J0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zb3VyY2UvU1ZHSW1wb3J0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLHFEQUFxRDs7O0FBRXJEOzs7R0FHRztBQUNILE1BQWEsV0FBVztJQUNwQjs7T0FFRztJQUNILE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLFFBQWdCO1FBQ2hDLElBQUksQ0FBQztZQUNELDRCQUE0QjtZQUM1QixNQUFNLE9BQU8sR0FBRyxNQUFNLFdBQVcsQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLGFBQWE7WUFDNUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO2dCQUNYLE9BQU8sQ0FBQyxLQUFLLENBQUMsY0FBYyxRQUFRLEVBQUUsQ0FBQyxDQUFDO2dCQUN4QyxPQUFPLEtBQUssQ0FBQztZQUNqQixDQUFDO1lBRUQsK0JBQStCO1lBQy9CLE1BQU0sT0FBTyxHQUFHLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLGFBQWE7WUFFcEUsaUJBQWlCO1lBQ2pCLE1BQU0sSUFBSSxHQUFHLE1BQU0sTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLFlBQVksRUFBRSxRQUFRLENBQUMsQ0FBQztZQUM5RSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ1IsT0FBTyxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsUUFBUSxFQUFFLENBQUMsQ0FBQztnQkFDMUMsT0FBTyxLQUFLLENBQUM7WUFDakIsQ0FBQztZQUVELGNBQWM7WUFDZCxNQUFNLElBQUksR0FBRztnQkFDVCxJQUFJLEVBQUUsSUFBSTtnQkFDVixRQUFRLEVBQUUsSUFBSTtnQkFDZCxRQUFRLEVBQUUsV0FBVztnQkFDckIsSUFBSSxFQUFFLGFBQWEsRUFBRSxRQUFRO2dCQUM3QixLQUFLLEVBQUUsQ0FBQyxRQUFRLENBQUM7Z0JBQ2pCLFFBQVEsRUFB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QUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxRQUFnQjtRQUNqQyxPQUFPLE1BQU0sV0FBVyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUM5QyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxRQUFnQjtRQUNwQyxtQkFBbUI7UUFDbkIsZUFBZTtRQUNmLE1BQU0sT0FBTyxHQUFHLE1BQU0sV0FBVyxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsYUFBYTtRQUM1RSxJQUFJLENBQUMsT0FBTztZQUFFLE9BQU8sSUFBSSxDQUFDO1FBRTFCLE1BQU0sSUFBSSxHQUFHLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLGFBQWE7UUFDakUscUNBQ0ksUUFBUSxJQUNMLElBQUksS0FDUCxVQUFVLEVBQUUsQ0FBQyxDQUFDLE9BQU8sSUFDdkI7SUFDTixDQUFDO0NBQ0o7QUFyQkQsOENBcUJDIiwic291cmNlc0NvbnRlbnQiOlsiLy8vIDxyZWZlcmVuY2UgdHlwZXM9XCJAY29jb3MvY3JlYXRvci10eXBlcy9lZGl0b3JcIiAvPlxuXG4vKipcbiAqIFNWR+i1hOa6kOWvvOWFpeWZqO+8iOS4u+i/m+eoi+eJiOacrO+8iVxuICog5L2/55SoRWRpdG9yIEFQSeS4jui1hOa6kOaVsOaNruW6k+S6pOS6klxuICovXG5leHBvcnQgY2xhc3MgU1ZHSW1wb3J0ZXIge1xuICAgIC8qKlxuICAgICAqIOWvvOWFpVNWR+aWh+S7tlxuICAgICAqL1xuICAgIHN0YXRpYyBhc3luYyBpbXBvcnQoZmlsZVBhdGg6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgLy8gMS4g6K+75Y+W5paH5Lu25YaF5a6577yI5L2/55SoTm9kZS5qc+eahGZz5qih5Z2X77yJXG4gICAgICAgICAgICBjb25zdCBjb250ZW50ID0gYXdhaXQgU1ZHSW1wb3J0ZXIucmVhZEZpbGVWaWFFZGl0b3IoZmlsZVBhdGgpOyAvLyDinIUg5q2j56Gu6LCD55So6Z2Z5oCB5pa55rOVXG4gICAgICAgICAgICBpZiAoIWNvbnRlbnQpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGDml6Dms5Xor7vlj5ZTVkfmlofku7Y6ICR7ZmlsZVBhdGh9YCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyAyLiDop6PmnpBTVkfkv6Hmga/vvIjnuq/mlofmnKzop6PmnpDvvIzkuI3kvb/nlKhET00gQVBJ77yJXG4gICAgICAgICAgICBjb25zdCBzdmdJbmZvID0gU1ZHSW1wb3J0ZXIucGFyc2VTVkdJbmZvVGV4dChjb250ZW50KTsgLy8g4pyFIOato+ehruiwg+eUqOmdmeaAgeaWueazlVxuXG4gICAgICAgICAgICAvLyAzLiDliJvlu7rotYTmupDnmoRtZXRh5paH5Lu2XG4gICAgICAgICAgICBjb25zdCB1dWlkID0gYXdhaXQgRWRpdG9yLk1lc3NhZ2UucmVxdWVzdChcImFzc2V0LWRiXCIsIFwicXVlcnktdXVpZFwiLCBmaWxlUGF0aCk7XG4gICAgICAgICAgICBpZiAoIXV1aWQpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGDml6Dms5Xojrflj5bmlofku7bnmoRVVUlEOiAke2ZpbGVQYXRofWApO1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gNC4g5p6E5bu6bWV0YeaVsOaNrlxuICAgICAgICAgICAgY29uc3QgbWV0YSA9IHtcbiAgICAgICAgICAgICAgICB1dWlkOiB1dWlkLFxuICAgICAgICAgICAgICAgIGltcG9ydGVkOiB0cnVlLFxuICAgICAgICAgICAgICAgIGltcG9ydGVyOiBcInN2Zy1hc3NldFwiLFxuICAgICAgICAgICAgICAgIHR5cGU6IFwiY2MuU1ZHQXNzZXRcIiwgLy8g6Ieq5a6a5LmJ57G75Z6LXG4gICAgICAgICAgICAgICAgZmlsZXM6IFtmaWxlUGF0aF0sXG4gICAgICAgICAgICAgICAgc3ViTWV0YXM6IHt9LFxuICAgICAgICAgICAgICAgIHVzZXJEYXRhOiB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IFwic3ZnLWFzc2V0XCIsXG4gICAgICAgICAgICAgICAgICAgIHN2Z0NvbnRlbnQ6IGNvbnRlbnQsXG4gICAgICAgICAgICAgICAgICAgIC4uLnN2Z0luZm8sXG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZUZpbGU6IGZpbGVQYXRoLFxuICAgICAgICAgICAgICAgICAgICBsYXN0TW9kaWZpZWQ6IERhdGUubm93KCksXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB2ZXI6IFwiMS4wLjBcIixcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIC8vIDUuIOS/neWtmG1ldGHmlofku7ZcbiAgICAgICAgICAgIGF3YWl0IEVkaXRvci5NZXNzYWdlLnJlcXVlc3QoXCJhc3NldC1kYlwiLCBcInNhdmUtYXNzZXQtbWV0YVwiLCB1dWlkLCBKU09OLnN0cmluZ2lmeShtZXRhLCBudWxsLCAyKSk7XG5cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBTVkfmlofku7blr7zlhaXlrozmiJA6ICR7ZmlsZVBhdGh9YCk7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFNWR+WvvOWFpei/h+eoi+S4reWPkeeUn+mUmeivrzpgLCBlcnJvcik7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDpgJrov4dOb2RlLmpzIGZz5qih5Z2X6K+75Y+W5paH5Lu277yI5Li76L+b56iL5Y+v55So77yJXG4gICAgICovXG4gICAgc3RhdGljIGFzeW5jIHJlYWRGaWxlVmlhRWRpdG9yKGZpbGVQYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZyB8IG51bGw+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIC8vIOS9v+eUqE5vZGUuanPnmoRmc+aooeWdl+WcqOS4u+i/m+eoi+ivu+WPluaWh+S7tlxuICAgICAgICAgICAgY29uc3QgZnMgPSByZXF1aXJlKFwiZnNcIik7IC8vIOKchSBOb2RlLmpz55qEZnPmqKHlnZflnKjkuLvov5vnqIvlj6/nlKhcbiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgZnMucmVhZEZpbGUoZmlsZVBhdGgsIFwidXRmLThcIiwgKGVycjogYW55LCBkYXRhOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihg6K+75Y+W5paH5Lu25aSx6LSlOiAke2ZpbGVQYXRofWAsIGVycik7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKG51bGwpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGDor7vlj5bmlofku7blpLHotKU6ICR7ZmlsZVBhdGh9YCwgZXJyb3IpO1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDnuq/mlofmnKzop6PmnpBTVkfkv6Hmga/vvIjkuI3kvb/nlKhET00gQVBJ77yJXG4gICAgICovXG4gICAgc3RhdGljIHBhcnNlU1ZHSW5mb1RleHQoc3ZnQ29udGVudDogc3RyaW5nKTogYW55IHtcbiAgICAgICAgLy8g5L2/55So5q2j5YiZ6KGo6L6+5byP5LuO5paH5pys5Lit5o+Q5Y+W5L+h5oGvXG4gICAgICAgIGNvbnN0IHdpZHRoTWF0Y2ggPSBzdmdDb250ZW50Lm1hdGNoKC93aWR0aD1cIihbXlwiXSspXCIvKTtcbiAgICAgICAgY29uc3QgaGVpZ2h0TWF0Y2ggPSBzdmdDb250ZW50Lm1hdGNoKC9oZWlnaHQ9XCIoW15cIl0rKVwiLyk7XG4gICAgICAgIGNvbnN0IHZpZXdCb3hNYXRjaCA9IHN2Z0NvbnRlbnQubWF0Y2goL3ZpZXdCb3g9XCIoW15cIl0rKVwiLyk7XG4gICAgICAgIGNvbnN0IHRpdGxlTWF0Y2ggPSBzdmdDb250ZW50Lm1hdGNoKC88dGl0bGU+KFtePF0rKTxcXC90aXRsZT4vKTtcbiAgICAgICAgY29uc3QgZGVzY01hdGNoID0gc3ZnQ29udGVudC5tYXRjaCgvPGRlc2M+KFtePF0rKTxcXC9kZXNjPi8pO1xuXG4gICAgICAgIGxldCB3aWR0aCA9IDEwMCxcbiAgICAgICAgICAgIGhlaWdodCA9IDEwMDtcblxuICAgICAgICBpZiAod2lkdGhNYXRjaCkgd2lkdGggPSBTVkdJbXBvcnRlci5wYXJzZURpbWVuc2lvbih3aWR0aE1hdGNoWzFdKTsgLy8g4pyFIOato+ehruiwg+eUqOmdmeaAgeaWueazlVxuICAgICAgICBpZiAoaGVpZ2h0TWF0Y2gpIGhlaWdodCA9IFNWR0ltcG9ydGVyLnBhcnNlRGltZW5zaW9uKGhlaWdodE1hdGNoWzFdKTsgLy8g4pyFIOato+ehruiwg+eUqOmdmeaAgeaWueazlVxuXG4gICAgICAgIC8vIOS7jnZpZXdCb3jop6PmnpDlsLrlr7jvvIjlpoLmnpzlrZjlnKjvvIlcbiAgICAgICAgaWYgKHZpZXdCb3hNYXRjaCAmJiB2aWV3Qm94TWF0Y2hbMV0pIHtcbiAgICAgICAgICAgIGNvbnN0IHBhcnRzID0gdmlld0JveE1hdGNoWzFdLnNwbGl0KFwiIFwiKS5tYXAoTnVtYmVyKTtcbiAgICAgICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPj0gNCAmJiBwYXJ0c1syXSA+IDAgJiYgcGFydHNbM10gPiAwKSB7XG4gICAgICAgICAgICAgICAgd2lkdGggPSBwYXJ0c1syXTtcbiAgICAgICAgICAgICAgICBoZWlnaHQgPSBwYXJ0c1szXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB3aWR0aCxcbiAgICAgICAgICAgIGhlaWdodCxcbiAgICAgICAgICAgIGFzcGVjdFJhdGlvOiBoZWlnaHQgPiAwID8gd2lkdGggLyBoZWlnaHQgOiAxLFxuICAgICAgICAgICAgdmlld0JveDogdmlld0JveE1hdGNoID8gdmlld0JveE1hdGNoWzFdIDogXCJcIixcbiAgICAgICAgICAgIGRlZmF1bHRDb2xvcjogXCIjZmZmZmZmXCIsXG4gICAgICAgICAgICB0aXRsZTogdGl0bGVNYXRjaCA/IHRpdGxlTWF0Y2hbMV0gOiBcIlwiLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246IGRlc2NNYXRjaCA/IGRlc2NNYXRjaFsxXSA6IFwiXCIsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgcGFyc2VEaW1lbnNpb24oZGltOiBzdHJpbmcpOiBudW1iZXIge1xuICAgICAgICBjb25zdCBudW0gPSBwYXJzZUZsb2F0KGRpbSk7XG4gICAgICAgIHJldHVybiBpc05hTihudW0pID8gMCA6IG51bTtcbiAgICB9XG59XG5cbi8qKlxuICogU1ZH6LWE5rqQ5aSE55CG5ZmoXG4gKi9cbmV4cG9ydCBjbGFzcyBTVkdBc3NldFByb2Nlc3NvciB7XG4gICAgc3RhdGljIGFzeW5jIHByb2Nlc3MoZmlsZVBhdGg6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICByZXR1cm4gYXdhaXQgU1ZHSW1wb3J0ZXIuaW1wb3J0KGZpbGVQYXRoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDojrflj5ZTVkfpooTop4ggLSDmraTmlrnms5XpnIDopoHlnKjpnaLmnb/vvIjmuLLmn5Pov5vnqIvvvInkuK3lrp7njrBcbiAgICAgKi9cbiAgICBzdGF0aWMgYXN5bmMgZ2V0UHJldmlldyhmaWxlUGF0aDogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgLy8g6L+Z6YeM5LiN55u05o6l5riy5p+T77yM6ICM5piv6L+U5Zue5paH5Lu25L+h5oGvXG4gICAgICAgIC8vIOWunumZhea4suafk+W6lOivpeWcqOmdouadv+S4rei/m+ihjFxuICAgICAgICBjb25zdCBjb250ZW50ID0gYXdhaXQgU1ZHSW1wb3J0ZXIucmVhZEZpbGVWaWFFZGl0b3IoZmlsZVBhdGgpOyAvLyDinIUg55u05o6l6LCD55So6Z2Z5oCB5pa55rOVXG4gICAgICAgIGlmICghY29udGVudCkgcmV0dXJuIG51bGw7XG5cbiAgICAgICAgY29uc3QgaW5mbyA9IFNWR0ltcG9ydGVyLnBhcnNlU1ZHSW5mb1RleHQoY29udGVudCk7IC8vIOKchSDnm7TmjqXosIPnlKjpnZnmgIHmlrnms5VcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGZpbGVQYXRoLFxuICAgICAgICAgICAgLi4uaW5mbyxcbiAgICAgICAgICAgIGhhc0NvbnRlbnQ6ICEhY29udGVudCxcbiAgICAgICAgfTtcbiAgICB9XG59XG4iXX0=